# ‚òïÔ∏è AUTOCAZING PORTING MANUAL

## Î™©Ï∞®

1. ÌôòÍ≤Ω ÏÑ§Ï†ï
2. Î∞∞Ìè¨
3. Ïô∏Î∂Ä ÏÑúÎπÑÏä§
4. ÏãúÏó∞ ÏãúÎÇòÎ¶¨Ïò§

## 1. ÌôòÍ≤Ω ÏÑ§Ï†ï

### üî® Í∞úÎ∞ú ÌôòÍ≤Ω

-   FrontEnd
    -   IDE : VisualStudio Code
    -   Node v20.11.0
    -   CRA v5.1.6 & React v18.2.0
    -   Vite-Plugin-PWA v0.19.7
-   BackEnd
    -   IDE : IntelliJ
    -   JDK 17.0.9(zulu)
    -   SpringBoot v3.1.5
    -   SpringCloud v2022.0.4
-   InfraStructure
    -   server : ubuntu v20.04
    -   nginx v1.18.0
    -   docker v26.1.0
    -   ## docker compose v2.26.1
        -   MySQL mysql:latest
        -   Kafka bitnami/kafka:3.5.1-debian-11-r44
        -   registry registry
        -   jenkins jenkins/jenkins:jdk17

### ‚úÖ Nginx ÏÑ§Ïπò

```jsx
$ sudo apt-get install nginx
```

### ‚úÖ Encrypt(SSL Î∞úÍ∏â)

```jsx
$ sudo apt-get install letsencrypt
$ sudo letsencrypt certonly --standalone -d [ÎèÑÎ©îÏù∏]
```

### üìã Nginx ÏÑ§Ï†ï

```
# You should look at the following URL's in order to grasp a solid understanding
# of Nginx configuration files in order to fully unleash the power of Nginx.
# https://www.nginx.com/resources/wiki/start/
# https://www.nginx.com/resources/wiki/start/topics/tutorials/config_pitfalls/
# https://wiki.debian.org/Nginx/DirectoryStructure
#
# In most cases, administrators will remove this file from sites-enabled/ and
# leave it as reference inside of sites-available where it will continue to be
# updated by the nginx packaging team.
#
# This file will automatically load configuration files provided by other
# applications, such as Drupal or Wordpress. These applications will be made
# available underneath a path with that package name, such as /drupal8.
#
# Please see /usr/share/doc/nginx-doc/examples/ for more detailed examples.
##

# Default server configuration
#
server {

	# SSL configuration
	#
	# listen 443 ssl default_server;
	# listen [::]:443 ssl default_server;
	#
	# Note: You should disable gzip for SSL traffic.
	# See: https://bugs.debian.org/773332
	#
	# Read up on ssl_ciphers to ensure a secure configuration.
	# See: https://bugs.debian.org/765782
	#
	# Self signed certs generated by the ssl-cert package
	# Don't use them in a production server!
	#
	# include snippets/snakeoil.conf;

	root /var/www/html;

	# Add index.php to the list if you are using PHP
	index index.html index.htm index.nginx-debian.html;

	server_name k10e204.p.ssafy.io;

	location / {
		# First attempt to serve request as file, then
		# as directory, then fall back to displaying a 404.
		try_files $uri $uri/ /index.html =404;
	}

	# pass PHP scripts to FastCGI server
	#
	#location ~ \.php$ {
	#	include snippets/fastcgi-php.conf;
	#
	#	# With php-fpm (or other unix sockets):
	#	fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
	#	# With php-cgi (or other tcp sockets):
	#	fastcgi_pass 127.0.0.1:9000;
	#}

	# deny access to .htaccess files, if Apache's document root
	# concurs with nginx's one
	#
	#location ~ /\.ht {
	#	deny all;
	#}

	# -------------- For MSA section --------------
	# API Gateway server
	location /api {
                proxy_pass  http://localhost:8080;
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
        }

	# SSE endpoint
    	location /api/alerts/connect {
        	proxy_pass http://localhost:8080;
        	proxy_http_version 1.1;
        	proxy_set_header Connection '';
        	proxy_buffering off;
        	proxy_set_header Host $host;
        	proxy_set_header X-Real-IP $remote_addr;
        	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        	proxy_set_header X-Forwarded-Proto $scheme;

		# Add these timeout settings
        	proxy_read_timeout 24h;
       		proxy_send_timeout 24h;
        	proxy_connect_timeout 24h;
    	}

	# Config Server
        location /msa/config/ { # ÎÅùÏóê /Î•º Ìï¥Ï£ºÏßÄ ÏïäÏúºÎ©¥ Îã®ÏàúÌûà Ìè¨Ìä∏ Ïó∞Í≤∞Îßå ÏàòÌñâÌïòÎ©∞, /msa/config Ïù¥ÌõÑÏùò Í≤ΩÎ°úÎäî Ï†ÑÎã¨ÌïòÏßÄ ÏïäÏùå
                proxy_pass  http://localhost:8888/;
		proxy_set_header Host $host;
		proxy_set_header X-Real-IP $remote_addr;
	    	proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  		proxy_set_header X-Forwarded-Proto $scheme;
        }

    listen [::]:443 ssl ipv6only=on; # managed by Certbot
    listen 443 ssl; # managed by Certbot
    ssl_certificate /etc/letsencrypt/live/k10e204.p.ssafy.io/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/k10e204.p.ssafy.io/privkey.pem; # managed by Certbot
    include /etc/letsencrypt/options-ssl-nginx.conf; # managed by Certbot
    ssl_dhparam /etc/letsencrypt/ssl-dhparams.pem; # managed by Certbot


}

# Virtual Host configuration for example.com
#
# You can move that to a different file under sites-available/ and symlink that
# to sites-enabled/ to enable it.
#
#server {
#	listen 80;
#	listen [::]:80;
#
#	server_name example.com;
#
#	root /var/www/example.com;
#	index index.html;
#
#	location / {
#		try_files $uri $uri/ =404;
#	}
#}

server {
    if ($host = k10e204.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


	listen 80 default_server;
	listen [::]:80 default_server;

	server_name k10e204.p.ssafy.io;
    return 404; # managed by Certbot
}
```

### ‚úÖ Docker, Docker Compose ÏÑ§Ïπò

```
curl -fsSL https://get.docker.com -o dockerSetter.sh
sudo chmod 711 dockerSetter.sh
./dockerSetter.sh
```

### üìã docker-compose.yml

```
version: '3.8'

services:
  api-gateway-server:
    image: localhost:5000/api-gateway-server:${API_GATEWAY_SERVER_TAG}
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    ports:
      - "8080:8080"
    depends_on:
      - config-server
    networks:
      - prod-network

  discovery-server:
    image: localhost:5000/discovery-server:${DISCOVERY_SERVER_TAG}
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    ports:
      - "8761:8761"
    depends_on:
      - api-gateway-server
    networks:
      - prod-network

  config-server:
    image: localhost:5000/config-server:${CONFIG_SERVER_TAG}
    ports:
      - "8888:8888"
    depends_on:
      - mysql
      - Kafka00Service
      - Kafka01Service
      - Kafka02Service
      - redis
    networks:
      - prod-network

  auth-server:
    image: localhost:5000/auth-server:${AUTH_SERVER_TAG}
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    ports:
      - "8085:8080"
    depends_on:
      - api-gateway-server
    networks:
      - prod-network
      - auth-network

  inventory-service:
    image: localhost:5000/inventory-service:${INVENTORY_SERVICE_TAG}
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    ports:
      - "8086:8080"
    depends_on:
      - api-gateway-server
    networks:
      - prod-network

  alert-service:
    image: localhost:5000/alert-service:${ALERT_SERVICE_TAG}
    environment:
      SPRING_PROFILES_ACTIVE: prod
      SPRING_CLOUD_CONFIG_URI: http://config-server:8888
    ports:
      - "8087:8080"
    depends_on:
      - api-gateway-server
    networks:
      - prod-network

  solution-service:
    image: localhost:5000/solution-service:${SOLUTION_SERVICE_TAG}
    ports:
      - "8088:8088"
    depends_on:
      - api-gateway-server
    networks:
      - prod-network
      - metric-network

  mysql:
    image: mysql:latest
    volumes:
      - mysql-data:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: ssafy
      MYSQL_DATABASE: autocazing_inventor
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
    ports:
      - "3306:3306"
    networks:
      - prod-network

  influxdb:
    image: bitnami/influxdb:latest
    ports:
      - "3386:8086"
      - "3388:8088"
    environment:
      - INFLUXDB_ADMIN_USER_PASSWORD=ssafy123
      - INFLUXDB_ADMIN_USER_TOKEN=ssafy123
    volumes:
      - influxdb-data:/var/lib/influxdb
    networks:
      - metric-network

  redis:
    image: redis:latest
    ports:
      - "6379:6379"
    networks:
      - auth-network

  Kafka00Service:
    image: bitnami/kafka:3.5.1-debian-11-r44
    restart: unless-stopped
    ports:
      - '10000:9094'
    environment:
      - KAFKA_CFG_BROKER_ID=0
      - KAFKA_CFG_NODE_ID=0
      - KAFKA_KRAFT_CLUSTER_ID=HsDBs9l6UUmQq7Y5E6bNlw
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@Kafka00Service:9093,1@Kafka01Service:9093,2@Kafka02Service:9093
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,EXTERNAL://0.0.0.0:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://Kafka00Service:9092,EXTERNAL://k10e204.p.ssafy.io:10000
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=2
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_HEAP_OPTS=-Xmx512M -Xms512M
    volumes:
      - kafka0-data:/var/lib/kafka
    networks:
      - prod-network
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "0.5"
        reservations:
          memory: 512m
          cpus: "0.25"

  Kafka01Service:
    image: bitnami/kafka:3.5.1-debian-11-r44
    restart: unless-stopped
    ports:
      - '10001:9094'
    environment:
      - KAFKA_CFG_BROKER_ID=1
      - KAFKA_CFG_NODE_ID=1
      - KAFKA_KRAFT_CLUSTER_ID=HsDBs9l6UUmQq7Y5E6bNlw
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@Kafka00Service:9093,1@Kafka01Service:9093,2@Kafka02Service:9093
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,EXTERNAL://0.0.0.0:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://Kafka01Service:9092,EXTERNAL://k10e204.p.ssafy.io:10001
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=2
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_HEAP_OPTS=-Xmx512M -Xms512M
    volumes:
      - kafka1-data:/var/lib/kafka
    networks:
      - prod-network
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "0.5"
        reservations:
          memory: 512m
          cpus: "0.25"

  Kafka02Service:
    image: bitnami/kafka:3.5.1-debian-11-r44
    restart: unless-stopped
    ports:
      - '10002:9094'
    environment:
      - KAFKA_CFG_BROKER_ID=2
      - KAFKA_CFG_NODE_ID=2
      - KAFKA_KRAFT_CLUSTER_ID=HsDBs9l6UUmQq7Y5E6bNlw
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=0@Kafka00Service:9093,1@Kafka01Service:9093,2@Kafka02Service:9093
      - ALLOW_PLAINTEXT_LISTENER=yes
      - KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE=true
      - KAFKA_CFG_LISTENERS=PLAINTEXT://0.0.0.0:9092,CONTROLLER://0.0.0.0:9093,EXTERNAL://0.0.0.0:9094
      - KAFKA_CFG_ADVERTISED_LISTENERS=PLAINTEXT://Kafka02Service:9092,EXTERNAL://k10e204.p.ssafy.io:10002
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,EXTERNAL:PLAINTEXT,PLAINTEXT:PLAINTEXT
      - KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_REPLICATION_FACTOR=3
      - KAFKA_CFG_TRANSACTION_STATE_LOG_MIN_ISR=2
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
      - KAFKA_HEAP_OPTS=-Xmx512M -Xms512M
    volumes:
      - kafka2-data:/var/lib/kafka
    networks:
      - prod-network
    deploy:
      resources:
        limits:
          memory: 1g
          cpus: "0.5"
        reservations:
          memory: 512m
          cpus: "0.25"

  KafkaWebUiService:
    image: provectuslabs/kafka-ui:latest
    restart: always
    container_name: KafkaWebUiContainer
    ports:
      - '8090:8080' # Ìò∏Ïä§Ìä∏Ïùò 8085 Ìè¨Ìä∏Î•º Ïª®ÌÖåÏù¥ÎÑàÏùò 8080 Ìè¨Ìä∏Ïóê Î∞îÏù∏Îî©
    environment:
      - KAFKA_CLUSTERS_0_NAME=Local-Kraft-Cluster
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=Kafka00Service:9092,Kafka01Service:9092,Kafka02Service:9092
      - DYNAMIC_CONFIG_ENABLED=true
      - KAFKA_CLUSTERS_0_AUDIT_TOPICAUDITENABLED=true
      - KAFKA_CLUSTERS_0_AUDIT_CONSOLEAUDITENABLED=true
    depends_on:
      - Kafka00Service
      - Kafka01Service
      - Kafka02Service
    networks:
      - prod-network

volumes:
  mysql-data:
  influxdb-data:
  kafka0-data:
  kafka1-data:
  kafka2-data:

networks:
  prod-network:
    driver: bridge
  auth-network:
    driver: bridge
  metric-network:
    driver: bridge
```

### üìã spring boot Docker ÌååÏùº

```
# Use Zulu OpenJDK for the build stage
FROM azul/zulu-openjdk:17 as builder

# ARG to receive profile name during build( ex) docker build --build-arg PROFILE=dev -t your_image_name . )
# if no --build-arg option given, local will applied to image)
ARG PROFILE=prod

WORKDIR /home/ubuntu/your_deploy_dir_name

# Copy the jar from the build stage to the production image
COPY your_service_name-0.0.1-SNAPSHOT.jar your_service_name.jar

# Specify the entrypoint to start the application
ENTRYPOINT ["java", "-jar", "your_service_name.jar", "--spring.profiles.active=prod"]
```

### üìã FastAPI Docker ÌååÏùº

```
FROM python:3.11.9

WORKDIR /autocazing_solution

COPY requirements.txt /autocazing_solution/requirements.txt

RUN pip install --no-cache-dir --upgrade -r /autocazing_solution/requirements.txt

COPY . /autocazing_solution

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8088"]
```

### üìã ÌîÑÎ†àÏûÑÏõåÌÅ¨ ÏÑ§Ï†ï ÌååÏùº ÎÇ¥Ïö©

```jsx
---------Spring---------
application.yml ÎÇ¥ ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï

spring :
    profiles:
        active: ${profile}
    output:
        ansi:
            enabled: ALWAYS
    servlet:
        multipart:
            max-file-size: 50MB
            max-request-size: 50MB
#logging
logging:
    level:
        root: info
        org:
            hibernate:
                orm:
                    jdbc:
                        bind: trace
    pattern:
        file: "%d %-5level [%thread] %logger : %msg%n"
#swagger
springdoc:
    packages-to-scan: com.dororo.api
    default-consumes-media-type: application/json;charset=UTF-8
    default-produces-media-type: application/json;charset=UTF-8
    api-docs:
        path: /api/api-docs
    swagger-ui:
        path: /api/docs # Swagger ÌéòÏù¥ÏßÄÎ°ú Ï†ëÏÜçÌï† Í≤ΩÎ°ú
        disable-swagger-default-url: true   # Í∏∞Î≥∏ ÌéòÏù¥ÏßÄÎ°ú Î¶¨ÎîîÎ†âÏÖò ÎêòÏßÄ ÏïäÍ≤å ÌïòÎäî ÏÑ§Ï†ïÏûÖÎãàÎã§
        operations-sorter: alpha    # APIÎ•º ÏóîÎìú Ìè¨Ïù∏Ìä∏Îì§Ïùò ÏïåÌååÎ≤≥ ÏàúÏÑúÎ°ú Ï†ïÎ†¨
        enabled: true   # Ïô∏Î∂ÄÏóêÏÑú Ï†ëÏÜç Í∞ÄÎä•ÌïòÍ≤å ÌïòÎäî ÏÑ§Ï†ï

----------------------------------------------------------------------

application-{profile}.yml ÎÇ¥ ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï

secret-key: {secret-key}
spring :
  data:
    redis:
      host: {host-url}
      port: 6379
  security:
    oauth2:
      client:
        registration:
          naver:
            client-id: {id}
            client-secret: {secret}
            redirect-uri: '{baseUrl}/oauth2/callback/naver'
            authorization-grant-type: authorization_code
            scope: name
        provider:
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response
  datasource:
    driver-class-name: org.postgresql.Driver
    url: jdbc:postgresql://{domain/db-name}
    username: {username}
    password: {password}
  jpa:
    show-sql: true
    hibernate:
      ddl-auto: none
      format_sql: true
      jdbc:
        lob:
          non_contextual_creation: true
    database: postgresql
    database-platform: org.hibernate.spatial.dialect.postgis.PostgisPG95Dialect
cloud:
  aws:
    region:
      static: ap-northeast-2
      auto: false # ÏûêÎèô region ÌÉêÏßÄ ÏòµÏÖò. falseÎ°ú ÏÑ§Ï†ïÌñàÏúºÎØÄÎ°ú ÏúÑÏùò ap-northeast-2(ÏÑúÏö∏ region)ÏúºÎ°ú Ï†ÅÏö© Îê®
    s3:
      bucket: {bucket-name}
    stack:  # AWS CloudFormation Ïä§ÌÉùÍ≥º Ïó∞ÎèôÌïòÏó¨ Î¶¨ÏÜåÏä§Ïùò ÏûêÎèô Í∞êÏßÄ Î∞è Íµ¨ÏÑ±ÏùÑ ÌôúÏÑ±Ìôî Ìï† ÏßÄ Ïó¨Î∂Ä. falseÎäî CloudFormation Ïä§ÌÉùÏùÑ ÌÜµÌïú Î¶¨ÏÜåÏä§ Í¥ÄÎ¶¨ÎÇò ÏûêÎèô Í∞êÏßÄÎ•º ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÍ≤†Îã§Îäî ÏùòÎØ∏
      auto: false
    credentials:
        access-key: {key}
        secret-key: {key}
```

## 2. Î∞∞Ìè¨

### üöÄ ÏàòÎèôÎ∞∞Ìè¨ Î∞©Î≤ï

1. ÏÜåÏä§ ÏΩîÎìú Î≥µÏ†ú

    $ git clone https://lab.ssafy.com/s10-bigdata-recom-sub2/S10P22E202.git

2. FrontEnd

```
$ cd /path-to-git-directory/client
$ npm ci
$ npm run build
$ sudo rm -rf /var/www/html/* && sudo cp -r /home/ubuntu/cd_client/* /var/www/html/
```

3. BackEnd

```
$ cd /path-to-git-directory/server
$ chmod +x gradlew
$ ./gradlew build
$ cd /build/libs
$ nohup java -jar -Dspring.profiles.active={your-want-profile} your_file_name-0.0.1-SNAPSHOT.jar
```

---

## 3. ÏãúÏó∞ ÏãúÎÇòÎ¶¨Ïò§
